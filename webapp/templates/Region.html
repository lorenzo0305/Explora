<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WishAdventure ‚Äî R√©gion</title>

  <link rel="stylesheet" href="/static/styles/app.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#190028; --accent:#FF6000; --text:#F9F0F7; --text-dim:rgba(249,240,247,.80);
      --card:#1e1e1e; --nav-h:64px; --content-max: 1100px; --page-pad: clamp(12px, 3vw, 24px);
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; }

    .wrap{
      min-height:100vh; padding-bottom: calc(var(--nav-h) + env(safe-area-inset-bottom) + 12px);
      display:flex; flex-direction:column; align-items:center; gap:18px;
      background: linear-gradient(180deg, #52B2CF 9%, #190028 18%);
    }

    .header{
      width:100%; max-width:var(--content-max);
      padding: 14px var(--page-pad) 8px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .title{
      width:100%; max-width:var(--content-max);
      padding: 0 var(--page-pad) 10px;
      display:flex; flex-direction:column; gap:10px;
    }
    .region-name{
      font-size: clamp(22px, 5.5vw, 32px); font-weight:700; text-align:center;
    }

    /* Recherche locale (dans la r√©gion) */
    .search-area{
      width:min(820px, 100%); margin: 0 auto; position:relative;
      display:flex; align-items:center; gap:10px; justify-content:space-between;
    }
    .search-wrap{
      flex:1;
      background:#F9F0F7; border-radius:10px; padding:7px 11px;
      display:flex; align-items:center; gap:7px;
    }
    .search-icon{ width:25px; height:25px; background:#190028; border-radius:4px; flex:0 0 25px }
    #search{
      flex:1; border:none; outline:none; background:transparent; font-size:15px; color:#190028;
    }
    .results{
      position:absolute; top: calc(100% + 6px); left: 0; right: 0;
      display:none; background:#0f0a18; border:1px solid rgba(255,255,255,.12);
      border-radius:10px; overflow:auto; max-height:min(60vh, 520px); z-index: 10;
    }
    .result-item{
      display:flex; align-items:center; gap:10px; padding:10px 12px;
      background:#fdfeff; color:#000; cursor:pointer; justify-content:space-between;
    }
    .result-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .result-item + .result-item{ border-top:1px solid #e9ecef }
    .result-item:hover{ background:#e9ecef }
    .result-thumb{ width:60px; height:60px; border-radius:8px; object-fit:cover; flex:0 0 60px; }
    .result-name{ font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:60vw; }
    .no-res{ padding:10px 12px; background:#fdfeff; color:#000 }
    .results-loader, .results-end{
      padding:10px 12px; background:#fdfeff; color:#000; text-align:center; font-size:13px; border-top:1px solid #e9ecef;
    }
    /* Bouton + dans les r√©sultats (√† droite) */
    .result-add{ flex:0 0 auto; }
    .result-add .add{
      width:28px; height:28px; border-radius:999px; border:none; cursor:pointer;
      background:var(--accent); color:#190028; font-weight:800; display:flex; align-items:center; justify-content:center;
      box-shadow:0 2px 8px rgba(0,0,0,.2);
    }
    .result-add .add:active{ transform: translateY(1px); }

    /* Sections cat√©gories */
    .section{
      width:100%; max-width:var(--content-max);
      padding: 0 var(--page-pad) 10px;
      display:flex; flex-direction:column; gap:10px;
    }
    .section h3{ margin:0; font-size: clamp(18px,3.3vw,22px); font-weight:600; }
    .row{
      display:flex; gap:12px; overflow:auto; padding-bottom:6px; scrollbar-width: thin;
    }

    /* Card */
    .card{
      position:relative;
      min-width: 180px; max-width: 220px;
      background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.06); border-radius:12px;
      padding:10px; display:flex; flex-direction:column; gap:8px; cursor:pointer;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .card:hover{ transform: translateY(-2px); box-shadow:0 6px 18px rgba(0,0,0,.18) }
    .thumb{ width:100%; aspect-ratio: 4/3; border-radius:8px; background:#2b2137; background-size:cover; background-position:center; }
    .name{ font-size:14px; font-weight:700; line-height:1.25 }
    .meta{ font-size:12px; opacity:.8 }

    /* + bouton sur la card */
    .add-btn{
      position:absolute; top:8px; right:8px;
      width:28px; height:28px; border-radius:999px;
      background:var(--accent); color:#190028; border:none; font-weight:800;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,.3);
    }
    .add-btn:active{ transform: translateY(1px); }

    /* Panier & Favoris */
    .actions{ position:relative; display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
    .basket-btn{
      background:rgba(255,255,255,.08); color:#fff; border:none;
      padding:6px 10px; border-radius:8px; font-weight:600; font-size:12px; line-height:1;
      cursor:pointer; display:flex; align-items:center; gap:6px;
    }
    #basketCount{
      font-size:11px; background:var(--accent); color:#190028; border-radius:999px; padding:2px 6px; font-weight:800;
    }
    #floatingBasket{
      position:absolute; top: calc(100% + 8px); right:0;
      width: min(420px, 80vw);
      max-height: min(60vh, 520px);
      overflow:auto;
      background:var(--card); border-radius:12px; padding:10px; display:none; z-index:20;
      box-shadow:0 16px 36px rgba(0,0,0,.45);
    }
    #floatingBasket h4{ margin:6px 0 8px; font-size:14px; opacity:.9 }
    .basket-empty{ color:var(--text-dim); font-size:13px; margin:6px 0; }
    .basket-item{
      display:flex; align-items:center; gap:8px; padding:6px; border-radius:8px;
      background:rgba(255,255,255,.04); margin-bottom:6px;
    }
    .basket-item img{ width:36px; height:36px; border-radius:6px; object-fit:cover }
    .basket-item .bi-name{ font-size:13px; font-weight:600 }
    .basket-item .bi-meta{ font-size:11px; opacity:.75 }
    .basket-item .bi-remove{
      margin-left:auto; background:rgba(255,255,255,.08); color:#fff; border:none;
      padding:4px 8px; border-radius:6px; font-size:11px; cursor:pointer;
    }
    .basket-footer{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
    .basket-footer a, .basket-footer button{
      background:var(--accent); color:#190028; border:none; border-radius:8px; padding:6px 10px; font-weight:800; cursor:pointer;
    }

    /* --- Styles pour les Favoris (C≈ìur) --- */
    .like-btn {
      background: rgba(255, 255, 255, .08); color: #fff; border: none;
      padding: 6px 10px; border-radius: 8px; font-weight: 600; font-size: 12px; line-height: 1;
      cursor: pointer; display: flex; align-items: center; gap: 6px;
    }
    .like-btn.active { color: #ff4081; }

    #likesCount {
      font-size: 11px; background: #ff4081; color: #fff; border-radius: 999px; padding: 2px 6px; font-weight: 800;
    }

    #floatingLikes {
      position: absolute; top: calc(100% + 8px); right: 0;
      width: min(420px, 80vw); max-height: min(60vh, 520px); overflow: auto;
      background: var(--card); border-radius: 12px; padding: 10px; display: none; z-index: 20;
      box-shadow: 0 16px 36px rgba(0,0,0,.45);
    }
    #floatingLikes h4 { margin: 6px 0 8px; font-size: 14px; opacity: .9; }
    .likes-empty { color: var(--text-dim); font-size: 13px; margin: 6px 0; }

    /* Bouton coeur sur les items du panneau */
    .bi-like-remove {
      margin-left: auto; background: transparent; color: #ff4081; border: 1px solid rgba(255,255,255,0.1);
      padding: 4px 8px; border-radius: 6px; font-size: 14px; cursor: pointer;
    }

    /* Bouton coeur individuel (sur les cartes/r√©sultats) */
    .fav-action {
      background: rgba(255,255,255,0.1); border:none; border-radius:50%;
      width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 14px; color: #ccc; transition: all 0.2s;
    }
    .fav-action.active { color: #ff4081; background: rgba(255, 64, 129, 0.15); transform: scale(1.1); }
    .fav-action:hover { background: rgba(255,255,255,0.2); }

    /* Bottom nav */
    nav.bottom-nav{
      position: fixed; left:0; right:0; bottom:0; height:var(--nav-h);
      display:flex; gap:8px; padding:10px; background:rgba(0,0,0,.25); backdrop-filter:blur(6px);
      border-top:1px solid rgba(255,255,255,.06);
    }
    .boutonNav{
      flex:1; border:none; border-radius:12px; padding:10px 8px;
      background:rgba(255,255,255,.06); color:#fff; font-weight:600; cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:6px;
    }
    .boutonNav.active{ background:var(--accent); color:#190028 }
    .nav-icon{ width:18px; height:18px; vertical-align:-3px; fill:#fff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <a href="/exploration" title="Retour" style="text-decoration:none; color:#F9F0F7;">‚Üê Retour</a>
      <div style="width:32px;height:32px;"></div>
    </div>

    <div class="title">
      <div id="regionName" class="region-name">R√©gion</div>

      <div class="search-area">
        <div class="search-wrap">
          <div class="search-icon" aria-hidden="true"></div>
          <input id="search" type="text" placeholder="Recherchez dans cette r√©gion..." autocomplete="off" />
        </div>

        <div class="actions">
          <button id="likesIcon" class="like-btn" type="button" title="Mes Favoris">
            ‚ù§Ô∏è <span id="likesCount" hidden>0</span>
          </button>
          <div id="floatingLikes" aria-live="polite"></div>

          <button id="basketIcon" class="basket-btn" type="button" title="Panier">
            üß∫ <span id="basketCount" hidden>0</span>
          </button>
          <div id="floatingBasket" aria-live="polite"></div>
        </div>

        <div id="results" class="results" role="listbox" aria-label="R√©sultats dans la r√©gion"></div>
      </div>
    </div>

    <section class="section">
      <h3>Patrimoine culturel</h3>
      <div id="row-CulturalSite" class="row"></div>
    </section>

    <section class="section">
      <h3>Restauration & producteurs</h3>
      <div id="row-FoodEstablishment" class="row"></div>
    </section>

    <section class="section">
      <h3>Points d‚Äôint√©r√™t</h3>
      <div id="row-PlaceOfInterest" class="row"></div>
    </section>
  </div>

  <nav class="bottom-nav">
    <a href="/accueil" class="bouton"><button class="boutonNav"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3z"/></svg> Accueil</button></a>
    <a href="/exploration" class="bouton">
      <button class="boutonNav active">
        <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="11" cy="11" r="6"></circle><path d="M20 20l-3.5-3.5" stroke="white" stroke-width="2" stroke-linecap="round" fill="none"/></svg>
        Exploration
      </button>
    </a>
    <a href="/carnet" class="bouton"><button class="boutonNav">Carnet</button></a>
    <a href="/creation" class="bouton"><button class="boutonNav">Cr√©ation</button></a>
  </nav>

  <script>
    // ------- Helpers -------
    const $ = s => document.querySelector(s);
    function debounce(fn, wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
    function getSlugFromPath(){
      const parts = location.pathname.split('/').filter(Boolean);
      return decodeURIComponent(parts[parts.length-1] || '');
    }
    const escAttr = s => String(s ?? '').replace(/"/g,'&quot;');
  
    // -------- Normalisation r√©gion --------
    const REGION_ALIASES = {
      "hauts-de-france": "Hauts-de-France",
      "hdf": "Hauts-de-France",
      "auvergne-rhone-alpes": "Auvergne-Rh√¥ne-Alpes",
      "ara": "Auvergne-Rh√¥ne-Alpes",
    };
    function toAsciiSlug(s){
      return String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    }
    function resolveRegion(slugFromUrl){
      const key = toAsciiSlug(slugFromUrl);
      const display = REGION_ALIASES[key] || slugFromUrl;
      const apiSlug = display;
      return { displayName: display, apiSlug };
    }

    /* ---------------- FAVORIS (LIKES) ---------------- */
    const LIKES_KEY = 'wish_likes_v1';
    const likesIcon = document.getElementById('likesIcon');
    const likesCount = document.getElementById('likesCount');
    const floatingLikes = document.getElementById('floatingLikes');

    function loadLikes(){
      try{ const raw = localStorage.getItem(LIKES_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ return []; }
    }
    function saveLikes(items){
      localStorage.setItem(LIKES_KEY, JSON.stringify(items));
      updateLikesCount(); renderLikesPanel();
      // Rafraichir les boutons visibles
      document.querySelectorAll('.fav-action').forEach(btn => {
        // Pour les cartes (qui ont l'id sur le parent)
        if(btn.parentElement.dataset.id){
           if(isLiked(btn.parentElement.dataset.id)) btn.classList.add('active');
           else btn.classList.remove('active');
        }
        // Pour les r√©sultats de recherche (qui ont l'id sur eux-m√™mes)
        if(btn.dataset.id){
           if(isLiked(btn.dataset.id)) btn.classList.add('active');
           else btn.classList.remove('active');
        }
      });
    }
    function updateLikesCount(){
      const n = loadLikes().length;
      likesCount.textContent = n; likesCount.hidden = n === 0;
    }
    function isLiked(id){
      return loadLikes().some(x => String(x.id) === String(id));
    }
    function toggleLike(item){
      let items = loadLikes();
      const idStr = String(item.id);
      if (items.some(x => String(x.id) === idStr)){
        items = items.filter(x => String(x.id) !== idStr);
      } else {
        const img = (item.image && item.image !== '/static/img/no-image.jpg') ? item.image : '/static/img/no-image.jpg';
        items.push({ id: item.id, name: item.name, image: img, types: item.types||[] });
      }
      saveLikes(items);
      return isLiked(item.id);
    }
    function renderLikesPanel(){
      const items = loadLikes();
      if (!items.length){
        floatingLikes.innerHTML = '<h4>Mes Favoris</h4><p class="likes-empty">Aucun coup de c≈ìur pour l‚Äôinstant.</p>';
        return;
      }
      const list = items.map(x => (
        `<div class="basket-item">
          <img src="${x.image || '/static/img/no-image.jpg'}" alt="">
          <div>
            <div class="bi-name">${x.name || 'Sans nom'}</div>
            <div class="bi-meta">${(x.types && x.types[0]) ? x.types[0] : ''}</div>
          </div>
          <button class="bi-like-remove" onclick="event.stopPropagation(); toggleLike({id:'${x.id}'})">üíî</button>
        </div>`
      )).join('');
      floatingLikes.innerHTML = '<h4>Mes Favoris</h4>' + list;
    }
    likesIcon.addEventListener('click', (e)=>{
      e.stopPropagation();
      const visible = floatingLikes.style.display === 'block';
      if(floatingBasket) floatingBasket.style.display='none';
      floatingLikes.style.display = visible ? 'none' : 'block';
      if (!visible) renderLikesPanel();
    });
    document.addEventListener('click', (e)=>{
      if (!floatingLikes.contains(e.target) && e.target !== likesIcon) floatingLikes.style.display = 'none';
    });
    updateLikesCount();
  
    // ---------- Panier ----------
    const BASKET_KEY = 'wish_basket_v1';
    const basketIcon = document.getElementById('basketIcon');
    const basketCount = document.getElementById('basketCount');
    const floatingBasket = document.getElementById('floatingBasket');
  
    function loadBasket(){
      try{ const raw = localStorage.getItem(BASKET_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ return []; }
    }
    function saveBasket(items){
      localStorage.setItem(BASKET_KEY, JSON.stringify(items));
      updateBasketCount(); renderBasketPanel();
    }
    function updateBasketCount(){
      const n = loadBasket().length;
      basketCount.textContent = n; basketCount.hidden = n === 0;
    }
    function addToBasket(item){
      const items = loadBasket();
      if (!items.some(x => String(x.id) === String(item.id))){
        items.push({ id:item.id, name:item.name, image:item.image || '', types:item.types||[] });
        saveBasket(items);
      }
    }
    function removeFromBasket(id){
      const items = loadBasket().filter(x => String(x.id) !== String(id));
      saveBasket(items);
    }
    function renderBasketPanel(){
      const items = loadBasket();
      if (!items.length){
        floatingBasket.innerHTML = '<h4>Votre panier</h4><p class="basket-empty">Aucun √©l√©ment pour l\u2019instant.</p><div class="basket-footer"><a href="/creation">Aller √† la cr√©ation</a></div>';
        return;
      }
      const list = items.map(x => (
        `<div class="basket-item">
          <img src="${x.image || '/static/img/no-image.jpg'}" alt="">
          <div>
            <div class="bi-name">${x.name || 'Sans nom'}</div>
            <div class="bi-meta">${(x.types && x.types[0]) ? x.types[0] : ''}</div>
          </div>
          <button class="bi-remove" data-id="${x.id}">Retirer</button>
        </div>`
      )).join('');
      floatingBasket.innerHTML = '<h4>Votre panier</h4>' + list + '<div class="basket-footer"><a href="/creation">Aller √† la cr√©ation</a></div>';
      floatingBasket.querySelectorAll('.bi-remove').forEach(btn=>{
        btn.addEventListener('click', (e)=>{ e.stopPropagation(); removeFromBasket(btn.getAttribute('data-id')); });
      });
    }
    basketIcon.addEventListener('click', (e)=>{
      e.stopPropagation();
      const visible = floatingBasket.style.display === 'block';
      if(floatingLikes) floatingLikes.style.display='none';
      floatingBasket.style.display = visible ? 'none' : 'block';
      if (!visible) renderBasketPanel();
    });
    document.addEventListener('click', (e)=>{
      if (!floatingBasket.contains(e.target) && e.target !== basketIcon) floatingBasket.style.display = 'none';
    });
    updateBasketCount();
  
    // ------- Cards -------
    function cardHTML(item){
      const img = item.image || '/static/img/no-image.jpg';
      const loc = item.locality ? `<div class="meta">${item.locality}</div>` : '';
      const name = item.name || 'Sans nom';
      const types = Array.isArray(item.types) ? item.types.join('|') : '';
      const likedClass = isLiked(item.id) ? 'active' : '';

      return `<div class="card" data-id="${escAttr(item.id)}" data-name="${escAttr(name)}" data-image="${escAttr(img)}" data-types="${escAttr(types)}">
        <button class="fav-action ${likedClass}" 
                style="position:absolute; top:8px; left:8px; z-index:2; background:rgba(0,0,0,0.5);"
                onclick="event.stopPropagation(); var p=this.parentElement; toggleLike({id:p.dataset.id, name:p.dataset.name, image:p.dataset.image, types:p.dataset.types.split('|')});"
                title="Mettre en favoris">‚ù§</button>
        
        <button class="add-btn" title="Ajouter au panier" aria-label="Ajouter au panier">+</button>
        <div class="thumb" style="background-image:url('${img}')"></div>
        <div class="name">${name}</div>
        ${loc}
      </div>`;
    }
    function bindCards(container){
      container.querySelectorAll('.card').forEach(c=>{
        c.addEventListener('click', ()=>{
          const id = c.getAttribute('data-id');
          if (id) location.href = `/object/${encodeURIComponent(id)}`;
        });
        const add = c.querySelector('.add-btn');
        if (add){
          add.addEventListener('click', (e)=>{
            e.stopPropagation();
            const id = c.dataset.id;
            const name = c.dataset.name || 'Sans nom';
            const image = c.dataset.image || '';
            const types = (c.dataset.types || '').split('|').filter(Boolean);
            addToBasket({ id, name, image, types });
          });
        }
      });
    }
  
    async function loadCategory(apiSlug, typ, limit=24){
      const row = document.getElementById(`row-${typ}`);
      if (!row) return;
      row.innerHTML = '';
      try {
        const r = await fetch(`/regions/${encodeURIComponent(apiSlug)}/cards?type=${encodeURIComponent(typ)}&limit=${limit}`);
        const items = r.ok ? await r.json() : [];
        row.innerHTML = items.map(cardHTML).join('') || '<div style="opacity:.7">Aucun √©l√©ment</div>';
        bindCards(row);
      } catch(e){
        row.innerHTML = '<div style="color:#f88">Erreur de chargement</div>';
      }
    }
  
    // ------- Recherche locale -------
    const resultsBox = document.getElementById('results');
    const searchInput = document.getElementById('search');
    function clearResults(){ resultsBox.innerHTML=''; resultsBox.style.display='none'; }
    function renderResults(items){
      resultsBox.innerHTML = '';
      if (!items || !items.length){
        resultsBox.innerHTML = '<div class="no-res">Aucun r√©sultat</div>';
      } else {
        items.forEach(item=>{
          const row = document.createElement('div');
          row.className = 'result-item';
          row.addEventListener('click', ()=>{ location.href = `/object/${encodeURIComponent(item.id)}`; });

          const left = document.createElement('div'); left.className='result-left';
          const img = document.createElement('img'); img.className='result-thumb'; img.src=item.image||'/static/img/no-image.jpg'; img.alt=item.name||'R√©sultat';
          const meta = document.createElement('div');
          const name = document.createElement('div'); name.className='result-name'; name.textContent=item.name||'Sans nom';
          const type = document.createElement('div'); type.style.fontSize='12px'; type.style.opacity='.75'; type.textContent=(item.types&&item.types[0])?item.types[0]:'';
          meta.append(name,type); left.append(img,meta);

          // Container Actions (Like + Add)
          const right = document.createElement('div');
          right.className = 'result-add';
          right.style.display = 'flex'; right.style.gap = '8px'; right.style.alignItems = 'center';

          // Like
          const heartBtn = document.createElement('button');
          heartBtn.className = isLiked(item.id) ? 'fav-action active' : 'fav-action';
          heartBtn.textContent = '‚ù§';
          heartBtn.dataset.id = item.id;
          heartBtn.style.background = 'transparent'; heartBtn.style.border = '1px solid #eee';
          heartBtn.style.color = heartBtn.classList.contains('active') ? '#ff4081' : '#ccc';
          heartBtn.addEventListener('click', (e)=>{
            e.stopPropagation();
            const liked = toggleLike(item);
            heartBtn.className = liked ? 'fav-action active' : 'fav-action';
            heartBtn.style.color = liked ? '#ff4081' : '#ccc';
          });

          // Add
          const addBtn = document.createElement('button');
          addBtn.className = 'add'; addBtn.textContent = '+';
          addBtn.addEventListener('click', (e)=>{ e.stopPropagation(); addToBasket(item); });

          right.appendChild(heartBtn);
          right.appendChild(addBtn);

          row.append(left, right);
          resultsBox.append(row);
        });
      }
      resultsBox.style.display='block';
    }
  
    let searchSeq = 0;
    const doSearch = debounce(async function(q, apiSlug){
      const query = (q || '').trim();
      if (query.length < 2){ clearResults(); return; }
      const mySeq = ++searchSeq;
      resultsBox.innerHTML = '<div class="results-loader">Recherche‚Ä¶</div>';
      resultsBox.style.display = 'block';
      try{
        const r = await fetch(`/regions/${encodeURIComponent(apiSlug)}/cards?q=${encodeURIComponent(query)}&limit=60`, { cache: 'no-store' });
        if (mySeq !== searchSeq) return;
        if (!r.ok){ clearResults(); return; }
        const data = await r.json();
        renderResults(data);
      }catch(e){
        if (mySeq !== searchSeq) return;
        clearResults();
      }
    }, 250);
  
    // ------- Init -------
    document.addEventListener('DOMContentLoaded', ()=>{
      const rawSlug = getSlugFromPath();
      const { displayName, apiSlug } = resolveRegion(rawSlug);
      document.getElementById('regionName').textContent = displayName || 'R√©gion';
      loadCategory(apiSlug, 'CulturalSite', 24);
      loadCategory(apiSlug, 'FoodEstablishment', 24);
      loadCategory(apiSlug, 'PlaceOfInterest', 24);
      searchInput.addEventListener('input', e => doSearch(e.target.value, apiSlug));
      document.addEventListener('click', (e)=>{
        if (!resultsBox.contains(e.target) && e.target !== searchInput) resultsBox.style.display='none';
      });
    });
  </script>
</body>
</html>