<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WishAdventure ‚Äî Cr√©ation</title>

  <link rel="stylesheet" href="/static/styles/app.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#190028;
      --accent:#FF6000;
      --text:#F9F0F7;
      --text-dim:rgba(249,240,247,.80);
      --card:#1e1e1e;
      --nav-h:64px;
      --content-max: 1100px;
      --page-pad: clamp(12px, 3vw, 24px);
      --createbar-h: 58px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      min-height:100vh;
    }
    .app{
      width:100vw; min-height:100vh;
      padding: clamp(40px,6vh,56px) var(--page-pad) calc(var(--nav-h) + env(safe-area-inset-bottom) + var(--page-pad));
      display:flex; flex-direction:column; align-items:center; gap:clamp(12px,2.5vh,20px);
      overflow: visible;
      border-radius:20px;
      background:#190028;
    }

    .header-row{
      width:100%; max-width:var(--content-max);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 8px var(--page-pad);
      position: sticky; top: 0; z-index: 1000;
      background: rgba(25,0,40,.85);
      backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(255,255,255,.06);
      border-radius: 0 0 14px 14px;
    }
    .header-left{ display:flex; align-items:center; gap:12px }
    .logo-dot{ width:25px; height:25px; background:var(--accent); border-radius:4px }
    .page-title{ font-size: clamp(22px,4.5vw,32px); font-weight:600; text-transform:capitalize }

    /* Actions (Panier / Coeur) */
    .actions{ position:relative; display:flex; align-items:center; gap:8px; }
    .action-btn{
      background:rgba(255,255,255,.08); color:#fff; border:none;
      padding:6px 10px; border-radius:8px; font-weight:600; font-size:12px; line-height:1;
      cursor:pointer; display:flex; align-items:center; gap:6px;
    }
    .action-btn.active { color: #ff4081; }
    .badge{ font-size:11px; background:var(--accent); color:#190028; border-radius:999px; padding:2px 6px; font-weight:800; }
    .badge.pink{ background:#ff4081; color:#fff; }

    /* Floating Panels (z-index √©lev√© pour passer au dessus) */
    .floating-panel{
      position:absolute; top:calc(100% + 8px); right:0;
      width:min(300px, 80vw); max-height:min(50vh, 400px); overflow:auto;
      background:#1e1e1e; border-radius:12px; padding:10px; display:none; z-index:2000;
      box-shadow:0 16px 36px rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.1);
    }
    .floating-panel h4{ margin:6px 0 8px; font-size:14px; opacity:.9; border-bottom:1px solid rgba(255,255,255,.1); padding-bottom:6px; }
    .panel-empty{ color:var(--text-dim); font-size:13px; margin:6px 0; font-style:italic; }
    .panel-item{
      display:flex; align-items:center; gap:8px; padding:6px; border-radius:8px;
      background:rgba(255,255,255,.04); margin-bottom:6px;
    }
    .panel-item[draggable="true"]{ cursor:grab }
    .panel-item img{ width:36px; height:36px; border-radius:6px; object-fit:cover }
    .panel-item .pi-name{ font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:140px; }
    .panel-item .pi-remove{
      margin-left:auto; background:rgba(255,255,255,.08); color:#fff; border:none;
      padding:4px 8px; border-radius:6px; font-size:11px; cursor:pointer;
    }

    .title-row{
      width:100%; max-width:var(--content-max);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 8px var(--page-pad);
      position: sticky; top: var(--createbar-h); z-index: 999;
      background: rgba(25,0,40,.70);
      backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(255,255,255,.05);
      border-radius: 0 0 12px 12px;
    }
    .title-left{ display:flex; align-items:center; gap:10px; flex:1; min-width:0; }
    .back-btn{ background:rgba(255,255,255,.08); color:#fff; border:none; width:34px; height:34px; border-radius:8px; font-size:18px; line-height:1; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .title{ font-size: clamp(22px, 3vw, 36px); font-weight:600; color:var(--text); background:transparent; border:none; outline:none; padding:0; width:100%; }
    .title::placeholder{color:var(--text); opacity:.9}
    .save-btn{ background:var(--accent); color:#190028; border:none; padding:8px 12px; border-radius:10px; font-weight:700; font-size:12px; cursor:pointer; box-shadow:0 2px 10px rgba(255,96,0,.25); }

    .editor{ width:100%; max-width:var(--content-max); display:flex; flex-direction:column; gap:16px; padding: 0 var(--page-pad); }
    .add-photos{ height:100px; border-radius:10px; background:rgba(255,96,0,.15);
      box-shadow: inset 0 0 0 .5px var(--accent); display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; }
    .add-photos span{ font-size:30px; font-weight:300; color:var(--accent); text-transform:capitalize; line-height:1; }
    .photos-preview{ display:flex; gap:8px; flex-wrap:wrap; }
    .photos-preview img{ width:56px; height:56px; object-fit:cover; border-radius:8px; box-shadow:0 0 0 1px rgba(255,255,255,.06) inset; }
    
    .location{ background:#F9F0F7; color:#190028; border:none; border-radius:10px; padding:10px 12px; font-size:15px; }
    .mini-icons{ display:flex; gap:8px; }
    .mini{ background:rgba(255,255,255,.08); color:#fff; border:none; border-radius:8px; padding:8px 10px; }

    .day-title{ margin: 6px 0 6px; font-size:16px; font-weight:700; color:#fff; opacity:.95; }
    .day-section{ margin-bottom: 4px; }
    .slots{ display:grid; grid-template-columns:repeat(2, 1fr); gap:16px; margin-top:4px; }
    .slot{ min-height:160px; border-radius:12px; padding:10px; background:rgba(255,255,255,.02); box-shadow:inset 0 0 0 2px rgba(255,255,255,.06);
      display:flex; flex-direction:column; gap:8px; }
    .slot h5{margin:0 0 4px 0; font-weight:600; font-size:14px; color:var(--text-dim)}
    .slot.drag-over{ outline:2px dashed rgba(255,255,255,.45); outline-offset:2px; }
    .slot .drop-hint{ font-size:12px; color:var(--text-dim); opacity:.8; }

    .add-day-btn{ margin-top:12px; align-self:stretch; background:rgba(255,255,255,.08); color:#fff; border:1px dashed rgba(255,255,255,.25); padding:10px 12px; border-radius:10px; font-weight:700; cursor:pointer; }
    .add-day-btn:hover{ background:rgba(255,255,255,.12); }

    .activity{ background:var(--card); padding:6px; border-radius:8px; display:flex; align-items:center; gap:8px; cursor:grab;
      box-shadow:0 1px 0 rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.05); }
    .activity img{width:40px; height:40px; border-radius:6px; object-fit:cover}
    .activity span{color:#fff; font-size:13px}
    .activity .remove{ margin-left:auto; background:rgba(255,255,255,.12); color:#fff; border:none; border-radius:6px; padding:4px 8px; cursor:pointer; }

    nav.bottom-nav{ position: fixed; left:0; right:0; bottom:0; height:var(--nav-h); display:flex; gap:8px; padding:10px; background:rgba(0,0,0,.25); backdrop-filter:blur(6px); border-top:1px solid rgba(255,255,255,.06); }
    .boutonNav{ flex:1; border:none; border-radius:12px; padding:10px 8px; background:rgba(255,255,255,.06); color:#fff; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; }
    .boutonNav.active{ background:var(--accent); color:#190028 }
    .nav-icon{ width:18px; height:18px; vertical-align:-3px; fill:#fff; }

    @media (min-width: 992px){ .slots{ grid-template-columns:repeat(3, 1fr); } }
    @media (min-width: 1400px){ .slots{ grid-template-columns:repeat(4, 1fr); } }
  </style>
</head>
<body>

  <div class="app">
    <div class="header-row">
      <div class="header-left">
        <div class="logo-dot"></div>
        <div class="page-title">Cr√©ation</div>
      </div>
      
      <div class="actions">
        <button id="likesIcon" class="action-btn" type="button" title="Mes Favoris">
          ‚ù§Ô∏è <span id="likesCount" class="badge pink" hidden>0</span>
        </button>
        <div id="floatingLikes" class="floating-panel" aria-live="polite"></div>

        <button id="basketIcon" class="action-btn" type="button" title="Panier">
          üß∫ <span id="basketCount" class="badge" hidden>0</span>
        </button>
        <div id="floatingBasket" class="floating-panel" aria-live="polite"></div>
      </div>
    </div>

    <div class="title-row">
      <div class="title-left">
        <button class="back-btn" type="button" title="Retour" aria-label="Retour" onclick="window.location.href='/topics'">‚Üê</button>
        <input id="journeyName" class="title" placeholder="Titre" autocomplete="off" />
      </div>
      <button id="saveJourneyBtn" class="save-btn" type="button" title="Sauvegarder">üíæ Sauver</button>
    </div>

    <div class="editor">
      <div class="add-photos" id="addPhotos"><span>+ photos</span></div>
      <input type="file" id="photosInput" accept="image/*" multiple hidden>
      <div class="photos-preview" id="photosPreview" aria-live="polite"></div>

      <input id="journeyLocation" class="location" placeholder="Ville, lieux." autocomplete="off" />

      <div class="mini-icons">
        <button class="mini" type="button" title="Option A">Option A</button>
        <button class="mini" type="button" title="Option B">Option B</button>
      </div>

      <button id="addDayBtn" class="add-day-btn" type="button">Ôºã Ajouter une journ√©e</button>
      <form id="createJourneyForm" hidden></form>
    </div>
  </div>

  <nav class="bottom-nav">
    <a href="/"><button class="boutonNav"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3z"/></svg>Accueil</button></a>
    <a href="/Destinations"><button class="boutonNav"><svg class="nav-icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="6"></circle><path d="M20 20l-3.5-3.5" stroke="white" stroke-width="2" stroke-linecap="round" fill="none"/></svg>Exploration</button></a>
    <a href="/topics"><button class="boutonNav"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M5 4h11a2 2 0 0 1 2 2v12H7a2 2 0 0 1-2-2V4z"/><rect x="3" y="6" width="2" height="12" rx="1" ry="1"/><path d="M8 8h7M8 11h7M8 14h5" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>Carnet</button></a>
    <a href="/makejourney"><button class="boutonNav active"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 2a6 6 0 0 0-6 6c0 4.5 6 12 6 12s6-7.5 6-12a6 6 0 0 0-6-6zm0 8.5A2.5 2.5 0 1 1 12 5.5a2.5 2.5 0 0 1 0 5z"/><path d="M15.2 14.2l3.2 3.2-2.3 0.5-1.4 1.4-0.5-2.3 1-1z"/></svg>Cr√©ation</button></a>
  </nav>

  <script>
    /* ========= Cl√©s & helpers ========= */
    const BASKET_KEY  = 'wish_basket_v1';
    const LIKES_KEY   = 'wish_likes_v1';
    const JOURNEYS_KEY = 'wish_journeys_v1';

    const $  = (id)=>document.getElementById(id);
    const q  = (sel, root=document)=>root.querySelector(sel);
    const qa = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

    // Mode
    const urlParams = new URLSearchParams(location.search);
    const IS_EDIT   = urlParams.get('edit') === '1';
    const EDIT_ID   = IS_EDIT ? (urlParams.get('id') || sessionStorage.getItem('wish_edit_id') || '') : '';

    /* ========= Panier & Favoris Logic ========= */
    const basketIcon = $('basketIcon');
    const basketCount = $('basketCount');
    const floatingBasket = $('floatingBasket');
    const likesIcon = $('likesIcon');
    const likesCount = $('likesCount');
    const floatingLikes = $('floatingLikes');

    const loadData = (k) => { try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch{ return []; } };
    const saveData = (k, d) => { localStorage.setItem(k, JSON.stringify(d)); updateCounts(); renderPanels(); };

    function updateCounts(){
      const b = loadData(BASKET_KEY).length;
      basketCount.textContent = b; basketCount.hidden = b===0;
      const l = loadData(LIKES_KEY).length;
      likesCount.textContent = l; likesCount.hidden = l===0;
    }

    function renderPanel(key, container, title, emptyMsg, draggable=false){
      const items = loadData(key);
      if(!items.length){
        container.innerHTML = `<h4>${title}</h4><p class="panel-empty">${emptyMsg}</p>`;
        return;
      }
      const esc = (s)=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;');
      container.innerHTML = `<h4>${title}</h4>` + items.map(x => (
        '<div class="panel-item"'+ (draggable ? ' draggable="true"' : '') +
          ' data-id="'+esc(x.id)+'" data-name="'+esc(x.name)+'" data-image="'+esc(x.image||'')+'">'+
          '<img src="'+(x.image || '/static/img/no-image.jpg')+'" alt="">'+
          '<div class="pi-name">'+(esc(x.name)||'Sans nom')+'</div>'+
          '<button class="pi-remove" onclick="removeItem(\''+key+'\', \''+x.id+'\')">‚úï</button>'+
        '</div>'
      )).join('');

      // Wire drag events for basket
      if(draggable){
          qa('.panel-item', container).forEach(row=>{
            row.addEventListener('dragstart', e=>{
              const data = { id: row.dataset.id, name: row.dataset.name, image: row.dataset.image };
              try{ e.dataTransfer.setData('application/x-basket-item', JSON.stringify(data)); e.dataTransfer.effectAllowed = 'copy'; }catch{}
            });
          });
      }
    }

    function renderPanels(){
        renderPanel(BASKET_KEY, floatingBasket, 'Votre panier', 'Votre panier est vide.', true); // Panier draggable
        renderPanel(LIKES_KEY, floatingLikes, 'Mes Favoris', 'Aucun favori.', false); // Likes pas draggable (selon besoin)
    }

    window.removeItem = function(key, id){
      const data = loadData(key).filter(x => String(x.id) !== String(id));
      saveData(key, data);
    };

    basketIcon.addEventListener('click', (e)=>{
      e.stopPropagation();
      floatingLikes.style.display = 'none';
      floatingBasket.style.display = floatingBasket.style.display==='block' ? 'none' : 'block';
    });
    likesIcon.addEventListener('click', (e)=>{
      e.stopPropagation();
      floatingBasket.style.display = 'none';
      floatingLikes.style.display = floatingLikes.style.display==='block' ? 'none' : 'block';
    });
    document.addEventListener('click', (e)=>{
      if(!floatingBasket.contains(e.target) && e.target !== basketIcon) floatingBasket.style.display = 'none';
      if(!floatingLikes.contains(e.target) && e.target !== likesIcon) floatingLikes.style.display = 'none';
    });
    window.addEventListener('storage', (e)=>{ if (e.key===BASKET_KEY || e.key===LIKES_KEY){ updateCounts(); renderPanels(); } });


    /* ========= Editor Logic ========= */
    let draggingEl = null;

    function updateDropHints(){
      qa('.slot').forEach(s=>{
        const hint = q('.drop-hint', s);
        if (hint) hint.style.display = s.querySelector('.activity') ? 'none' : 'block';
      });
    }

    function createActivityElement(item){
      const el = document.createElement('div'); el.className = 'activity'; el.draggable = true;
      el.dataset.id = String(item.id); el.dataset.name = item.name || ''; el.dataset.image = item.image || item.photo || '';
      const imgSrc = item.image || item.photo || ('https://picsum.photos/seed/' + encodeURIComponent(item.id) + '/80/80');
      el.innerHTML = `<img alt="" src="${imgSrc}"><span>${item.name != null ? item.name : ('#'+item.id)}</span><button class="remove" title="Supprimer">‚úï</button>`;
      el.addEventListener('dragstart', (e)=>{ draggingEl = el; try{ e.dataTransfer.setData('text/x-activity','move'); e.dataTransfer.effectAllowed='move'; }catch{} });
      el.addEventListener('dragend', ()=>{ draggingEl = null; });
      q('.remove', el).addEventListener('click', ()=>{ el.parentElement?.removeChild(el); updateDropHints(); });
      return el;
    }

    function wireSlot(slot){
      slot.addEventListener('dragenter', (e)=>{ e.preventDefault(); slot.classList.add('drag-over'); });
      slot.addEventListener('dragleave', ()=>{ slot.classList.remove('drag-over'); });
    }
    document.addEventListener('dragover', (e)=>{ if(e.target?.closest?.('.slot')){ e.preventDefault(); e.target.closest('.slot').classList.add('drag-over'); } });
    document.addEventListener('drop', (e)=>{
      const slot = e.target?.closest?.('.slot');
      if (!slot) return;
      e.preventDefault(); e.stopPropagation();
      qa('.slot.drag-over').forEach(s=>s.classList.remove('drag-over'));
      if (draggingEl){ slot.appendChild(draggingEl); updateDropHints(); return; }
      try{
        const data = e.dataTransfer.getData('application/x-basket-item');
        if (data){ slot.appendChild(createActivityElement(JSON.parse(data))); updateDropHints(); }
      }catch{}
    });

    /* ========= Gestion des Jours (CORRECTION DOUBLON TITRE) ========= */
    function createDaySection(dayNumber){
      const sec = document.createElement('section');
      sec.className = 'day-section';
      sec.dataset.day = String(dayNumber);
      // CORRECTION: On NE met PAS le <h3> dans le innerHTML, car il est ajout√© avant la section par la fonction appelante
      sec.innerHTML = `
        <div class="slots">
          <div class="slot" data-key="morning"><h5>Matin√©e</h5><div class="drop-hint">D√©posez vos activit√©s ici</div></div>
          <div class="slot" data-key="noon"><h5>Midi</h5><div class="drop-hint">D√©posez vos activit√©s ici</div></div>
          <div class="slot" data-key="afternoon"><h5>Apr√®s-midi</h5><div class="drop-hint">D√©posez vos activit√©s ici</div></div>
          <div class="slot" data-key="evening"><h5>Soir√©e</h5><div class="drop-hint">D√©posez vos activit√©s ici</div></div>
        </div>`;
      qa('.slot', sec).forEach(wireSlot);
      return sec;
    }

    function clearAllDays(){
      qa('.day-section').forEach(s=>s.remove());
      qa('.day-title').forEach(t=>t.remove());
    }

    function resetEditorToEmpty(){
      clearAllDays();
      const editor = q('.editor');
      const first = createDaySection(1);
      const h = document.createElement('h3'); h.className='day-title'; h.textContent='Journ√©e 1';
      editor.insertBefore(h, q('#addDayBtn'));
      editor.insertBefore(first, q('#addDayBtn'));
      $('journeyName').value = ''; $('journeyLocation').value = ''; $('createJourneyForm').dataset.id = '';
      updateDropHints();
    }

    function addDay(){
      const editor = q('.editor');
      const n = qa('.day-section').length + 1;
      const sec = createDaySection(n);
      const h = document.createElement('h3'); h.className='day-title'; h.textContent = 'Journ√©e ' + n;
      editor.insertBefore(h, q('#addDayBtn'));
      editor.insertBefore(sec, q('#addDayBtn'));
      updateDropHints();
    }

    /* ========= Save & Load ========= */
    function loadJourneys(){ try{ return JSON.parse(localStorage.getItem(JOURNEYS_KEY)||'[]'); }catch{ return []; } }
    function saveJourneys(arr){ localStorage.setItem(JOURNEYS_KEY, JSON.stringify(arr)); }
    function uid(){ return 'j_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,7); }

    function collectPlan(){
      return qa('.day-section').map((sec, i)=>({
        day: i+1,
        slots: qa('.slot', sec).map(s=>({
          key: s.getAttribute('data-key'),
          items: qa('.activity', s).map(a=>({ id: a.dataset.id, name: a.dataset.name, image: a.dataset.image || '' }))
        }))
      }));
    }

    function upsertJourney(j){
      const all = loadJourneys();
      const idx = all.findIndex(x => x.id===j.id);
      if (idx >= 0) all[idx] = j; else all.unshift(j);
      saveJourneys(all);
      window.dispatchEvent(new StorageEvent('storage', { key: JOURNEYS_KEY }));
      alert('Voyage sauvegard√© ‚úîÔ∏è');
    }

    /* ========= Normalisation jours (pour √©dition) ========= */
    function deriveDays(obj){
      const A = (a)=>Array.isArray(a)?a:(a&&typeof a==='object')?Object.values(a):[];
      function slotsArrayToObj(slotsArr){
        const o = { morning:[], noon:[], afternoon:[], evening:[] };
        (Array.isArray(slotsArr)?slotsArr:[]).forEach(s=>{ const k=String(s?.key||'').toLowerCase(); if(o[k]) o[k]=A(s.items); });
        return o;
      }
      if (Array.isArray(obj?.plan)) return obj.plan.map((d,i)=>({ day:(d.day!=null?Number(d.day):i+1), slots: slotsArrayToObj(d.slots) }));
      return []; 
    }

    function renderForEdit(j){
      $('journeyName').value = j?.name || '';
      $('journeyLocation').value = j?.location || '';
      clearAllDays();
      const editor = q('.editor');
      const days = deriveDays(j);
      if (!days.length) {
          const first = createDaySection(1);
          const h = document.createElement('h3'); h.className='day-title'; h.textContent='Journ√©e 1';
          editor.insertBefore(h, q('#addDayBtn'));
          editor.insertBefore(first, q('#addDayBtn'));
      } else {
        days.forEach((d, i)=>{
          const sec = createDaySection(i+1);
          const h = document.createElement('h3'); h.className='day-title'; h.textContent='Journ√©e ' + (i+1);
          editor.insertBefore(h, q('#addDayBtn'));
          editor.insertBefore(sec, q('#addDayBtn'));
          ['morning','noon','afternoon','evening'].forEach(key=>{
            const slot = qa(`.slot[data-key="${key}"]`, sec)[0];
            if (!slot) return;
            (d.slots?.[key]||[]).forEach(item=>{ slot.appendChild(createActivityElement(item)); });
          });
        });
      }
      updateDropHints();
      $('createJourneyForm').dataset.id = String(j.id || '');
    }

    function loadForEditMaybe(){
      if (!IS_EDIT) return;
      let obj = null;
      if (EDIT_ID) try{ obj = (JSON.parse(localStorage.getItem(JOURNEYS_KEY)||'[]')).find(x => String(x.id)===String(EDIT_ID)) || null; }catch{}
      if (!obj) try{ obj = JSON.parse(sessionStorage.getItem('wish_edit_payload') || 'null'); }catch{}
      if (obj) renderForEdit(obj);
    }

    document.addEventListener('click', (e)=>{
      if (e.target?.id === 'saveJourneyBtn'){
        const form = $('createJourneyForm');
        const existingId = form?.dataset?.id || null;
        const journey = {
          id: existingId || uid(),
          name: ($('journeyName').value||'').trim() || 'Sans titre',
          location: ($('journeyLocation').value||'').trim(),
          cover: q('.activity img') ? q('.activity img').src : '/static/img/no-image.jpg',
          createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(),
          plan: collectPlan()
        };
        upsertJourney(journey);
        if (!existingId && form){ form.dataset.id = journey.id; }
      }
      if (e.target?.id === 'addDayBtn'){ addDay(); }
    });

    /* ========= Photos d√©mo ========= */
    const addPhotos = $('addPhotos'); const photosInput = $('photosInput'); const photosPreview = $('photosPreview');
    addPhotos?.addEventListener('click', ()=> photosInput?.click());
    photosInput?.addEventListener('change', ()=>{
      photosPreview.innerHTML = '';
      Array.from(photosInput.files||[]).slice(0,12).forEach(f=>{
        const url = URL.createObjectURL(f);
        const img = document.createElement('img'); img.src = url; photosPreview.appendChild(img);
      });
    });

    document.addEventListener('DOMContentLoaded', ()=>{
      updateCounts(); renderPanels();
      if (!IS_EDIT){ sessionStorage.removeItem('wish_edit_id'); sessionStorage.removeItem('wish_edit_payload'); resetEditorToEmpty(); } else { loadForEditMaybe(); }
    });
  </script>
</body>
</html>