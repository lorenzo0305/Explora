<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WishAdventure ‚Äî D√©tail</title>

  <link rel="stylesheet" href="/static/styles/app.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#190028;
      --accent:#FF6000;
      --text:#F9F0F7;
      --text-dim:rgba(249,240,247,.80);
      --card:rgba(255,255,255,.06);
      --nav-h:85px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:#0f0a18; color:var(--text);
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      min-height:100vh;
    }

    .app{
      width:100vw; height:100vh;
      background:linear-gradient(180deg, #FDC43F 10%, #190028 28%);
      position:relative; overflow:hidden;
      display:flex; flex-direction:column;
      border-radius:20px;
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:5;
      padding:10px 18px 12px;
      background:#FDC43F;
      display:flex; flex-direction:column; gap:8px;
    }
    .row{ display:flex; align-items:center; justify-content:space-between }
    .time{ font:600 17px/40px Inter, Poppins, sans-serif; color:#F9F0F7; letter-spacing:.35px }
    .status{ width:78px; height:12px; background:rgba(249,240,247,.9); border-radius:30px }
    .back{
      width:40px; height:40px; border-radius:9999px;
      background:rgba(20,20,20,.18);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; outline:1px solid rgba(249,240,247,.18);
    }
    .back svg{ width:18px; height:18px }
    .title{ font-size:20px; font-weight:600; color:#F9F0F7; text-align:center; flex:1 }

    /* Contenu */
    .page{
      flex:1; overflow:auto; scrollbar-width:thin;
      padding:24px 18px calc(var(--nav-h) + 24px);
      display:flex; flex-direction:column; gap:24px; align-items:flex-start;
    }
    .hero{ width:100%; display:flex; flex-direction:column; gap:12px; }
    .name-type{ display:flex; align-items:flex-end; gap:11px; flex-wrap:wrap; }
    .name{ font-size:30px; font-weight:600; color:#F9F0F7 }
    .type{ font-size:20px; font-weight:600; color:var(--text-dim) }
    .loc{ font-size:13px; color:var(--text-dim) }

    .meta-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .meta-left{ display:flex; align-items:center; gap:8px }
    .avatar{
      width:28px; height:28px; border-radius:50%;
      background:var(--accent);
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 0 0 1px rgba(0,0,0,.15) inset, 0 1px 2px rgba(0,0,0,.25);
      flex:0 0 28px;
    }
    .avatar svg{ width:18px; height:18px; }
    .you{ font-size:16px; font-weight:600; color:#F9F0F7 }
    .mini{ width:11px; height:11px; background:var(--accent); border-radius:50% }

    .cover{
      width:min(360px, 90vw); height:min(360px, 90vw);
      max-width:360px; max-height:360px;
      border-radius:10px; object-fit:cover;
      box-shadow:0 0 0 1px rgba(255,255,255,.08) inset;
      margin:0 auto;
    }

    .summary{ display:flex; align-items:center; gap:12px; font-size:13px; flex-wrap:wrap; justify-content:center; }
    .summary b{ font-weight:700 }

    .sec{ display:flex; flex-direction:column; gap:8px; width:min(720px, 100%); align-items:center; }
    .sec-ttl{ font-size:13px; color:var(--text-dim); text-align:center; }

    .card{
      padding:8px; border-radius:10.5px;
      background:rgba(232,197,224,.15);
      color:rgba(249,240,247,.90); font-size:14px;
      box-shadow:inset 0 0 0 1px rgba(249,240,247,.30);
      text-align:center; width:100%; max-width:720px;
      white-space: pre-line;
    }

    .photos{ display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; width:min(720px, 100%); margin:0 auto; }
    .ph{ aspect-ratio:1/1; border-radius:8px; background:rgba(133,50,110,.40); overflow:hidden;
         display:flex; align-items:center; justify-content:center; }
    .ph img{ width:100%; height:100%; object-fit:cover; display:block; }
    .ph.big{ grid-column:span 2; grid-row:span 2; background:#D18BCA; }
    .ph.add{ background:rgba(249,240,247,.30); outline:1px solid #F9F0F7; cursor:pointer; }

    .contacts{ display:flex; flex-direction:column; gap:6px; align-items:center; text-align:center; }
    .contact-line{ display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text); justify-content:center; }
    .contact-line a{ color:#F9F0F7; text-decoration:underline; }

    /* Bottom nav */
    nav.bottom-nav{
      position:fixed; left:0; right:0; bottom:0; height:var(--nav-h);
      background:#190028; display:flex; align-items:center; justify-content:center;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .nav-inner{ width:min(960px, 92vw); max-width:374px; display:flex; gap:16px; justify-content:center; }
    .boutonNav{ flex:0 0 77px; border:none; border-radius:8px; padding:8px 6px; background:transparent;
      color:#F9F0F7; font-weight:500; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px; }
    .boutonNav.active{ background:rgba(255,96,0,.50); outline:0.5px solid var(--accent); outline-offset:-.25px }
    .nav-icon{ width:31px; height:31px; fill:#F9F0F7 }

    @media (max-width:480px){
      .name{ font-size:26px }
      .type{ font-size:18px }
    }

    /* Centrer l‚Äôensemble */
    .page{ align-items:center; }
    .hero{ align-items:center; text-align:center; }
    .name-type{ justify-content:center; }
    .name, .type, .loc{ text-align:center; }

    /* Centrer le bouton + si seul */
    #addPhoto { justify-self:center; align-self:center; }
    #photosGrid > #addPhoto:only-child { grid-column:1 / -1; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Topbar -->
    <div class="topbar">
      <div class="row">
        <div class="time">09:23</div>
        <div class="status"></div>
      </div>
      <div class="row">
        <div class="back" id="backBtn" title="Retour" aria-label="Retour">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M14 6l-6 6 6 6" stroke="#F9F0F7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="title">{{ name or "D√©tail" }}</div>
        <div style="width:40px"></div>
      </div>
    </div>

    <!-- Contenu -->
    <div class="page">

      <div class="hero">
        <div class="name-type">
          <div class="name">{{ name or "Activit√©" }}</div>
          <div class="type"></div>
        </div>
        <div class="loc"></div>

        <div class="meta-row">
          <div class="meta-left">
            <div class="avatar" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <circle cx="12" cy="8" r="4" fill="#fff" opacity=".95"/>
                <path d="M4 20c0-3.5 3.6-6 8-6s8 2.5 8 6" fill="#fff" opacity=".95"/>
              </svg>
            </div>
            <div class="you">par vous</div>
            <div class="mini"></div>
          </div>
        </div>

        <!-- cover -->
        <img class="cover" src="{{ image or '/static/img/no-image.jpg' }}" alt="image de {{ name or 'activit√©' }}">

        <div class="summary" id="summaryLine" style="display:none">
          <span>pour <b id="sumPersons">‚Äî</b> pers.</span>
          <span>‚Ä¢ <b id="sumPrice">‚Äî‚Ç¨</b></span>
        </div>
      </div>

      <!-- Description -->
<div class="sec">
  <div class="sec-ttl">La description</div>
  <div class="card" id="descBox">
    {% if descriptions and descriptions|length > 0 %}
      {{ descriptions[0] }}
    {% else %}
      Pas de description disponible.
    {% endif %}
  </div>
</div>


      <!-- Vos photos -->
      <div class="sec">
        <div class="sec-ttl">Vos photos</div>
        <div class="photos" id="photosGrid">
          <label class="ph ph big ph add" id="addPhoto">
            <input id="fileInput" type="file" accept="image/*" multiple style="display:none">
            <span style="font-size:28px; font-weight:600">+</span>
          </label>
        </div>
      </div>

      <!-- R√©servation / Contacts -->
      <div class="sec">
        <div class="sec-ttl">R√©servation :</div>
        <div class="contacts"></div>
      </div>

      <!-- Notes priv√©es -->
      <div class="sec">
        <div class="sec-ttl" style="color:rgba(255,96,0,.80); text-decoration:underline;">Priv√©</div>
        <div class="card" style="background:rgba(232,197,224,.15); box-shadow:none;">
          <div style="font-size:12px; font-weight:600; color:rgba(249,240,247,.90); margin-bottom:6px">
            Notez vos ressentis et votre exp√©rience de l‚Äôactivit√© :
          </div>
          <textarea id="privateNotes" rows="5" placeholder="..." style="width:100%; resize:vertical; border:none; outline:none; background:transparent; color:#F9F0F7; font-size:14px"></textarea>
        </div>
      </div>

    </div>

    <!-- Bottom nav -->
    <nav class="bottom-nav">
      <div class="nav-inner">
        <a href="/"><button class="boutonNav">
          <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3z"/></svg>
          Accueil
        </button></a>
        <a href="/Destinations"><button class="boutonNav">
          <svg class="nav-icon" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="6"></circle>
            <path d="M20 20l-3.5-3.5" stroke="white" stroke-width="2" stroke-linecap="round" fill="none"/>
          </svg>
          Exploration
        </button></a>
        <a href="/topics"><button class="boutonNav active">
          <svg class="nav-icon" viewBox="0 0 24 24">
            <path d="M5 4h11a2 2 0 0 1 2 2v12H7a2 2 0 0 1-2-2V4z"/>
            <rect x="3" y="6" width="2" height="12" rx="1" ry="1"/>
            <path d="M8 8h7M8 11h7M8 14h5" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
          </svg>
          Carnet
        </button></a>
        <a href="/makejourney"><button class="boutonNav">
          <svg class="nav-icon" viewBox="0 0 24 24">
            <path d="M12 2a6 6 0 0 0-6 6c0 4.5 6 12 6 12s6-7.5 6-12a6 6 0 0 0-6-6zm0 8.5A2.5 2.5 0 1 1 12 5.5a2.5 2.5 0 0 1 0 5z"/>
            <path d="M15.2 14.2l3.2 3.2-2.3 0.5-1.4 1.4-0.5-2.3 1-1z"/>
          </svg>
          Cr√©ation
        </button></a>
      </div>
    </nav>
  </div>

  <script>
    /* ================== Utilitaires ================== */
    const DEFAULT_COVER = "/static/img/no-image.jpg";
    const isDefaultCover = (u) => !u || String(u).includes(DEFAULT_COVER);

    function getDetailId(){
      const m = location.pathname.match(/\/(?:detail-act-perso|object)\/(.+)$/);
      if (!m) return "";
      const raw = m[1];
      try { const once = decodeURIComponent(raw); try { return decodeURIComponent(once); } catch { return once; } }
      catch { return raw; }
    }
    function showErrorUI(msg){
      console.error(msg);
      document.querySelector(".title")?.insertAdjacentText("afterbegin", "D√©tail ‚Äî ");
      const nameEl = document.querySelector(".name");
      if (nameEl && !nameEl.textContent.trim()) nameEl.textContent = "Activit√© introuvable";
      const card = document.getElementById("descBox");
      if (card) card.textContent = typeof msg === "string" ? msg : "Impossible de r√©cup√©rer les donn√©es de l‚Äôactivit√©.";
      const cover = document.querySelector(".cover");
      if (cover) {
        const current = cover.getAttribute("src") || "";
        if (isDefaultCover(current)) cover.src = DEFAULT_COVER; // ne pas downgrader si une bonne image est d√©j√† affich√©e
      }
    }

    /* ================== Lookup local (voyages) ================== */
    const JOURNEY_KEYS = ["wish_journeys_v1","journeys"];
    function loadAllJourneys(){
      for (const k of JOURNEY_KEYS){
        try{
          const arr = JSON.parse(localStorage.getItem(k) || "[]");
          if (Array.isArray(arr) && arr.length) return arr;
        }catch{}
      }
      try{ return JSON.parse(localStorage.getItem(JOURNEY_KEYS[0]) || "[]"); }catch{ return []; }
    }
    const normArr = a => Array.isArray(a) ? a : (a && typeof a==="object") ? Object.values(a) : [];
    function slotsArrayToObj(slotsArr){
      const o = { morning:[], noon:[], afternoon:[], evening:[] };
      (Array.isArray(slotsArr)?slotsArr:[]).forEach(s=>{
        const k = String(s?.key||"").toLowerCase();
        if (o[k]) o[k] = normArr(s.items);
      });
      return o;
    }
    function normalizeDayAny(d,i){
      const day = (d && d.day!=null) ? Number(d.day) : (i||0)+1;
      if (Array.isArray(d?.slots)) return { day, slots: slotsArrayToObj(d.slots) };
      return {
        day,
        slots:{
          morning:normArr(d?.slots?.morning || d?.morning),
          noon:normArr(d?.slots?.noon || d?.noon),
          afternoon:normArr(d?.slots?.afternoon || d?.afternoon),
          evening:normArr(d?.slots?.evening || d?.evening),
        }
      };
    }
    function deriveDays(j){
      if (Array.isArray(j?.plan)) return j.plan.map((d,i)=>normalizeDayAny(d,i));
      let days = j?.days ?? j?.days_json;
      if (typeof days === "string"){ try{ days = JSON.parse(days);}catch{ days=null; } }
      if (Array.isArray(days)) return days.map((d,i)=>normalizeDayAny(d,i));
      const s = normalizeDayAny({ slots:j?.slots||{} },0).slots;
      const total = s.morning.length+s.noon.length+s.afternoon.length+s.evening.length;
      return total ? [{ day:1, slots:s }] : [];
    }
    function activityId(a){
      return a?.objectId || a?.id || a?._id || a?.["@id"] || a?.uri || a?.url || null;
    }
    function idsEqual(a, b){
      if (!a || !b) return false;
      a = String(a); b = String(b);
      if (a === b) return true;
      try { if (decodeURIComponent(a) === b) return true; } catch {}
      try { if (a === decodeURIComponent(b)) return true; } catch {}
      return false;
    }
    function findLocalObjectById(targetId){
      const journeys = loadAllJourneys();
      for (const j of journeys){
        const days = deriveDays(j);
        for (const d of days){
          for (const k of ["morning","noon","afternoon","evening"]){
            for (const a of normArr(d.slots?.[k])){
              const aid = activityId(a);
              if (idsEqual(aid, targetId)) return a;
            }
          }
        }
      }
      return null;
    }

    /* ================== R√©seau (proxy-first + IDs courts) ================== */
    function asRemoteUrl(id){
      if (!id) return null;
      if (/^https?:\/\//i.test(id)) return id;
      if (/^\d{2}\//.test(id)) return `https://data.datatourisme.fr/${id}`; // ex: 13/uuid
      if (/^data\.datatourisme\.fr\//i.test(id)) return `https://${id}`;
      return null;
    }
    async function tryJsonResponse(r){
      const ct = (r.headers && r.headers.get && r.headers.get("content-type")) || "";
      if (/json|ld\+json/i.test(ct)) return await r.json();
      const txt = await r.text();
      try { return JSON.parse(txt); } catch {
        console.warn("R√©ponse non-JSON:", txt.slice(0,160) + (txt.length>160?"‚Ä¶":""));
        throw new Error("R√©ponse non-JSON");
      }
    }
    async function fetchObjectRemote(id){
      const canon = asRemoteUrl(id) || id;
      if (!/^https?:\/\//i.test(canon)) return null;
      const tries = [
        `/api/object?url=${encodeURIComponent(canon)}`,
        `/proxy?url=${encodeURIComponent(canon)}`,
      ];
      for (const u of tries){
        try{
          const r = await fetch(u);
          if (r.ok) return await tryJsonResponse(r);
          const body = await r.text().catch(()=>"(no body)");
          console.warn(u, "‚Üí", r.status, body.slice(0,160));
        }catch(e){ console.warn(u, "√©chou√©:", e); }
      }
      try{
        const r = await fetch(canon, { headers: { "Accept":"application/ld+json, application/json;q=0.9, */*;q=0.1" } });
        if (r.ok) return await tryJsonResponse(r);
      }catch(e){ console.warn("Direct fetch √©chou√©:", e); }
      try{
        const url1 = canon.includes("?") ? canon+"&format=jsonld" : canon+"?format=jsonld";
        const r1 = await fetch(url1, { headers: { "Accept":"application/ld+json" } });
        if (r1.ok) return await tryJsonResponse(r1);
      }catch(e){ console.warn("fetch ?format=jsonld √©chou√©:", e); }
      return null;
    }

    /* ================== Normalisation (IRIs + FR-only desc) ================== */
    function pickLang(val){
      if (typeof val === "string") return val;
      if (Array.isArray(val)){
        let fr = val.find(v => v && (v["@language"]==="fr" || v.lang==="fr"));
        if (fr) return fr["@value"] || fr.value || "";
        let en = val.find(v => v && (v["@language"]==="en" || v.lang==="en"));
        if (en) return en["@value"] || en.value || "";
        const s = val.find(v => typeof v === "string");
        if (s) return s;
        const first = val[0];
        return (first && (first["@value"] || first.value)) || "";
      }
      if (val && typeof val === "object"){
        if (val.fr) return Array.isArray(val.fr) ? val.fr[0] : val.fr;
        if (val.en) return Array.isArray(val.en) ? val.en[0] : val.en;
        if (val["@value"]) return val["@value"];
      }
      return "";
    }
    function firstString(){
      for (let i=0; i<arguments.length; i++){
        const c = arguments[i];
        if (!c) continue;
        if (typeof c === "string" && c.trim()) return c.trim();
        if (Array.isArray(c)){
          const s = c.find(x => typeof x==="string" && x.trim());
          if (s) return s.trim();
          const t = c.find(x => x && (x["@value"] || x.value));
          if (t) return (t["@value"] || t.value || "").trim();
        }
        if (typeof c === "object"){
          const p = pickLang(c);
          if (p && typeof p === "string" && p.trim()) return p.trim();
        }
      }
      return "";
    }
    function arrayOfStrings(x){
      if (!x) return [];
      if (typeof x === "string") return [x];
      if (Array.isArray(x)) return x.map(e=> (typeof e==="string" ? e : (e && (e["@value"]||e.value) || ""))).filter(Boolean);
      if (typeof x === "object"){
        const v = pickLang(x);
        return v ? [v] : [];
      }
      return [];
    }
    // FR-only
    function getLangStrings(v, lang='fr'){
      const out = [];
      if (!v) return out;
      if (typeof v === 'string'){ out.push(v); return out; }
      if (Array.isArray(v)){ v.forEach(x => out.push(...getLangStrings(x, lang))); return out; }
      if (typeof v === 'object'){
        const fr = v[lang] || v[lang.toUpperCase()] || v[`${lang}-FR`] || v[`${lang}-fr`];
        if (fr){
          if (Array.isArray(fr)) fr.forEach(s => typeof s === 'string' && out.push(s));
          else if (typeof fr === 'string') out.push(fr);
        } else if ((v['@language'] && String(v['@language']).toLowerCase().startsWith(lang)) && (v['@value'] || v.value)){
          out.push(v['@value'] || v.value);
        }
      }
      return out;
    }

    const K_LABEL = [
      "name","title","dc:title","rdfs:label","schema:name",
      "http://www.w3.org/2000/01/rdf-schema#label",
      "https://schema.org/name"
    ];
    const K_IMAGE = ["image","photo","thumbnail","picture","cover","https://schema.org/image"];
    const K_CONTACT = {
      homepage: ["homepage","website","url","sameAs","http://xmlns.com/foaf/0.1/homepage","https://schema.org/url"],
      telephone:["telephone","phone","contactPhone","https://schema.org/telephone"],
      email:["email","mail","contactEmail","https://schema.org/email"]
    };

    // Raccourcit un IRI de type pour l‚Äôaffichage
    function shortType(t){
      if (!t) return "";
      if (/^https?:\/\//.test(t)){
        const lastHash = t.split("#").pop();
        const last = lastHash.includes("/") ? lastHash.split("/").pop() : lastHash;
        return last.replace(/_/g," ");
      }
      return String(t);
    }

    function extractImage(obj){
      // 1) champs directs / schema:image
      const direct = firstString(...K_IMAGE.map(k=>obj[k]));
      if (direct) return direct;

      // 2) Datatourisme: has(Main)Representation ‚Üí ebucore:hasRelatedResource ‚Üí ebucore:locator
      const dtRepKeys = [
        "https://www.datatourisme.fr/ontology/core#hasMainRepresentation",
        "https://www.datatourisme.fr/ontology/core#hasRepresentation",
        "hasMainRepresentation","hasRepresentation"
      ];
      for (const k of dtRepKeys){
        const reps = obj[k];
        if (Array.isArray(reps)){
          for (const rep of reps){
            if (!rep || typeof rep!=="object") continue;
            const rels = [].concat(rep["ebucore:hasRelatedResource"]||[], rep.hasRelatedResource||[]);
            for (const r of rels){
              if (!r || typeof r!=="object") continue;
              const locs = [].concat(r["ebucore:locator"]||[], r.locator||[]);
              for (const loc of locs){
                if (typeof loc === "string" && /\.(jpg|jpeg|png|gif|webp)(\?|#|$)/i.test(loc)) return loc;
                if (loc && typeof loc==="object"){
                  const u = firstString(loc.url, loc["@id"], loc["@value"]);
                  if (u && /\.(jpg|jpeg|png|gif|webp)(\?|#|$)/i.test(u)) return u;
                }
              }
            }
          }
        }
      }

      // 3) objets {contentUrl}/{url}
      for (const v of Object.values(obj)){
        if (Array.isArray(v)){
          for (const it of v){
            if (it && typeof it==="object"){
              const url = firstString(it.contentUrl, it.url, it["@id"], it["https://schema.org/contentUrl"], it["https://schema.org/url"]);
              if (url && /^https?:\/\//i.test(url) && /\.(jpg|jpeg|png|gif|webp)(\?|#|$)/i.test(url)) return url;
            }
          }
        }
      }

      // 4) heuristique g√©n√©rique
      for (const [k,v] of Object.entries(obj)){
        if (!/image|photo|thumbnail|picture|illustration/i.test(k)) continue;
        const arr = arrayOfStrings(v);
        const found = arr.find(u => /^https?:\/\/.+\.(jpg|jpeg|png|webp|gif)(\?|#|$)/i.test(u));
        if (found) return found;
      }
      return DEFAULT_COVER;
    }

    function normalizeContacts(obj){
      const contacts = [];
      const pick = (keys) => firstString(...keys.map(k=>obj[k]));
      const site = pick(K_CONTACT.homepage);
      const tel  = pick(K_CONTACT.telephone);
      const mail = pick(K_CONTACT.email);
      if (site || tel || mail) contacts.push({ homepage:site, telephone:tel, email:mail });

      const groups = [].concat(
        obj.hasContact||[], obj.contact||[], obj.contacts||[], obj.contactPoint||[], obj["schema:contactPoint"]||[],
        obj["https://www.datatourisme.fr/ontology/core#hasContact"]||[]
      );
      groups.forEach(c=>{
        if (!c || typeof c!=="object") return;
        const s = firstString(...K_CONTACT.homepage.map(k=>c[k]));
        const t = firstString(...K_CONTACT.telephone.map(k=>c[k]));
        const m = firstString(...K_CONTACT.email.map(k=>c[k]));
        if (s||t||m) contacts.push({ homepage:s, telephone:t, email:m });
      });
      const id = getDetailId();
      if (!contacts.length && /^https?:\/\//i.test(id)) contacts.push({ homepage:id });
      return contacts;
    }

    function extractDescriptionsFR(obj){
      const DIRECT_KEYS = [
        'description','dc:description','schema:description',
        'rdfs:comment','http://www.w3.org/2000/01/rdf-schema#comment',
        'shortDescription','longDescription',
        'https://www.datatourisme.fr/ontology/core#shortDescription',
        'https://www.datatourisme.fr/ontology/core#longDescription',
      ];
      let descs = [];
      DIRECT_KEYS.forEach(k => descs = descs.concat(getLangStrings(obj[k], 'fr')));

      const groups = [].concat(
        obj.hasDescription || [],
        obj['https://www.datatourisme.fr/ontology/core#hasDescription'] || []
      );
      groups.forEach(d => {
        descs = descs.concat(
          getLangStrings(d?.shortDescription, 'fr'),
          getLangStrings(d?.longDescription, 'fr'),
          getLangStrings(d?.description, 'fr'),
          getLangStrings(d?.['dc:description'], 'fr'),
          getLangStrings(d?.['schema:description'], 'fr'),
          getLangStrings(d?.['rdfs:comment'], 'fr'),
          getLangStrings(d?.['http://www.w3.org/2000/01/rdf-schema#comment'], 'fr')
        );
      });

      return descs.map(s => s.trim()).filter((s, i, a) => s && a.indexOf(s) === i);
    }

    function normalizeObject(objLike){
      const obj = objLike || {};

      // name
      const K_LABEL = [
        "name","title","dc:title","rdfs:label","schema:name",
        "http://www.w3.org/2000/01/rdf-schema#label",
        "https://schema.org/name"
      ];
      const name =
        firstString(...K_LABEL.map(k => obj[k])) ||
        (obj['@id'] ? String(obj['@id']).split('/').pop() : 'Activit√©');

      // types
      let types = [];
      if (Array.isArray(obj['@type'])) types = obj['@type'].map(String);
      else if (obj['@type']) types = [String(obj['@type'])];
      else if (obj.type) types = arrayOfStrings(obj.type);

      // desc FR
      const descriptions = extractDescriptionsFR(obj);

      // image + contacts
      const image = extractImage(obj);
      const contacts = normalizeContacts(obj);

      return { name, types, descriptions, image, contacts, raw: obj };
    }

    /* ================== Rendu ================== */
    function setText(sel, txt){ const el = document.querySelector(sel); if (el) el.textContent = txt; }

    // üëá Upgrade-only : on ne remplace JAMAIS une image d√©j√† bonne par le placeholder
    function setCover(src){
      const img = document.querySelector(".cover"); if (!img) return;
      const current = img.getAttribute("src") || "";
      const newSrc = src || "";
      const curIsDefault = isDefaultCover(current);
      const newIsDefault = isDefaultCover(newSrc);

      // Si la nouvelle est d√©faut mais l'actuelle ne l'est pas ‚Üí ne rien faire (√©vite le ‚Äúswitch‚Äù)
      if (newIsDefault && !curIsDefault) return;

      // Sinon, on met √† jour si diff√©rent
      if (newSrc && newSrc !== current) img.src = newSrc;
    }

    function renderType(t){
      const el = document.querySelector(".name-type .type");
      if (!el) return;
      el.textContent = t ? "‚Äî " + shortType(t) : "";
    }
    function renderContacts(list){
      const wrap = document.querySelector(".contacts");
      if (!wrap) return;
      wrap.innerHTML = "";
      if (!list || !list.length){
        wrap.innerHTML = `<div class="contact-line">Aucun contact fourni.</div>`;
        return;
      }
      list.forEach(c=>{
        const line = document.createElement("div");
        line.className = "contact-line";
        if (c.homepage){
          const a = document.createElement("a");
          a.href = c.homepage; a.target = "_blank"; a.rel = "noopener";
          a.textContent = "Site";
          line.appendChild(a);
        }
        if (c.telephone){
          const s = document.createElement("span");
          s.textContent = (c.homepage ? " ‚Ä¢ " : "") + c.telephone;
          line.appendChild(s);
        }
        if (c.email){
          const s = document.createElement("span");
          s.innerHTML = (c.homepage||c.telephone ? " ‚Ä¢ " : "") + `<a href="mailto:${c.email}">Email</a>`;
          line.appendChild(s);
        }
        wrap.appendChild(line);
      });
    }
    function renderDescription(descriptions){
      const box = document.getElementById("descBox");
      if (!box) return;
      const arr = Array.isArray(descriptions) ? descriptions.filter(Boolean) : [];
      if (!arr.length) {
    // Ne rien faire ‚Üí on garde le fallback rendu par Jinja (serveur)
        return;
      }
      box.textContent = arr.join("\n\n");
    }


    // (Optionnel) pr√©remplir depuis l‚ÄôURL: /object/:id?img=...&name=...
    function prefillFromQuery(){
      const p = new URLSearchParams(location.search);
      const img = p.get("img");
      const nm  = p.get("name");
      if (img) setCover(img);
      if (nm)  setText(".name", nm);
    }

    /* ================== Notes & Photos ================== */
    function initNotes(){
      const objId = getDetailId();
      const key = objId ? `object_notes_${objId}` : null;
      const ta = document.getElementById("privateNotes");
      if (!key || !ta) return;
      try { ta.value = localStorage.getItem(key) || ""; } catch(e){}
      ta.addEventListener("input", () => { try { localStorage.setItem(key, ta.value); } catch(e){} });
    }
    function initPhotos(){
      const objId = getDetailId();
      const key = objId ? `object_photos_${objId}` : null;
      const grid = document.getElementById("photosGrid");
      const input = document.getElementById("fileInput");
      const add = document.getElementById("addPhoto");
      function renderPhotos(urls){
        Array.from(grid.querySelectorAll(".ph.item")).forEach(n => n.remove());
        (urls||[]).forEach(u => {
          const d = document.createElement("div");
          d.className = "ph item";
          const img = document.createElement("img");
          img.src = u;
          d.appendChild(img);
          grid.appendChild(d);
        });
      }
      function load(){ if (!key) return []; try{ return JSON.parse(localStorage.getItem(key)||"[]"); }catch{return []} }
      function save(urls){ if (!key) return; try{ localStorage.setItem(key, JSON.stringify(urls)); }catch{} }
      add.addEventListener("click", () => input.click());
      input.addEventListener("change", async (e) => {
        const files = Array.from(e.target.files||[]);
        if (!files.length) return;
        const urls = load();
        for (const f of files){
          const dataUrl = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
          urls.push(dataUrl);
        }
        save(urls); renderPhotos(urls); input.value="";
      });
      renderPhotos(load());
    }

    /* ================== INIT ================== */
    document.getElementById("backBtn").addEventListener("click", () => history.back());

    (async function init(){
      // Pr√©remplissage √©ventuel (ne fait rien si pas de ?img=)
      prefillFromQuery();

      const id = getDetailId();
      if (!id){
        showErrorUI("ID introuvable dans l‚ÄôURL.");
        return;
      }
      console.debug("DetailActPerso id =", id);

      // 1) local d‚Äôabord
      let obj = findLocalObjectById(id);
      if (!obj) console.warn("Objet non trouv√© en local, tentative r√©seau‚Ä¶");

      // 2) r√©seau ‚Äî proxy d'abord (√©vite CORS)
      if (!obj){
        let remote = await fetchObjectRemote(id);
        if (!remote){
          showErrorUI("Impossible de r√©cup√©rer l‚Äôobjet (CORS ou ressource non JSON). Pense √† configurer un proxy /api/object.");
          return;
        }
        const canon = asRemoteUrl(id) || id;
        const suffix = String(canon).split("/13/").pop(); // cas Datatourisme (ORG 13)

        if (Array.isArray(remote)){
          obj = remote.find(n => n && typeof n==="object" && (idsEqual(n["@id"], canon) || (n["@id"] && n["@id"].endsWith(suffix)))) || remote[0];
        } else if (remote["@graph"] && Array.isArray(remote["@graph"])){
          obj = remote["@graph"].find(n => idsEqual(n["@id"], canon) || (n["@id"] && n["@id"].endsWith(suffix))) || remote["@graph"][0];
        } else {
          obj = remote;
        }
      }

      try{
        const norm = normalizeObject(obj || {});
        console.debug('normalized object:', norm);

        setText(".title", norm.name || "D√©tail");
        setText(".name",  norm.name || "Activit√©");
        renderType(norm.types && norm.types[0]);

        // ‚ö†Ô∏è Upgrade-only : ne pas √©craser une image d√©j√† bonne par un placeholder
        setCover(norm.image);

        renderDescription(norm.descriptions);
        renderContacts(norm.contacts);

        initNotes();
        initPhotos();
      } catch (e){
        console.error(e);
        showErrorUI("Erreur lors de l‚Äôaffichage de l‚Äôactivit√©.");
      }
    })();
  </script>
</body>
</html>
